---
# File: roles/kohalxcs/tasks/kohalxcs-setup.yaml
# #############################################################################
# Code is part of the KohaLXC/kohatools Ansible/Bash tooling environment
# for Koha/ILS-development, deployment & database conversion/migration tasks.
# Author: Jukka Aaltonen, Koha-Lappi, Rovaniemi City Library, Lapland/Finland.
# License: GNU General Public License version 3.
# 
# Description: setup tasks of Koha-related LXCs for dev/mdb/web/data envs
# - setup Koha-related LXCs environments in playbook inventories
# - ensure availability of all required distro packages and Perl-modules
# - 
# ##############################################################################

## Configure SMTP server for sending mail (postfix)
#TODO: if needed specify relay host/sasl config at the end of '/etc/postfix/main.cf':
#relayhost=smtp.gmail.com:587
#smtp_use_tls = yes
#smtp_sasl_auth_enable = yes
#smtp_sasl_security_options =
#smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
#smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt in '/etc/postfix/sasl_passwd':
#[smtp.gmail.com]:587 user@gmail.com:passwd
# - generate the lookup-db: "sudo postmap /etc/postfix/sasl_passwd
- name: koha - Configure SMTP server for sending mail (postfix)
  become: yes
  lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backrefs: yes
    backup: yes
  with_items:
    - { regexp: '^(myhostname =)(.*)', line: '\1 {{ kohalxcs_kohaenv_srvname }}' }
    - { regexp: '^(mydestination =)( .*{{ hostnode_kohaenv_srvdomain }},)(.*)', line: '\1 {{ kohalxcs_kohaenv_srvname }},\3' }
    - { regexp: '^(inet_interfaces =)(.*)', line: '\1 localhost' }
    #- { regexp: '^(#myorigin =)(.*)', line: '\1\2' }
    #- { regexp: '^(relayhost =)(.*)', line: '\1 [smtp.gmail.com]:587' }
  when:
    - kohalxcs_kohaenv_enabled

## Set the From/sender address fro SMTP/postfix
- name: koha - Set SMTP server From(sender) address in canonical map
  become: yes
  shell: |
    echo "@$(hostname) no-reply@{{ kohalxcs_kohaenv_srvname }}" > /etc/postfix/canonical;
    postmap /etc/postfix/canonical;
  when:
    - kohalxcs_kohaenv_enabled

## Configure SMTP/postifix to rewrite From/sender address to mails
- name: koha - Configure SMTP server/postfix From(sender) address
  become: yes
  blockinfile:
    dest: /etc/postfix/main.cf
    insertafter: EOF
    content: |
      sender_canonical_maps = hash:/etc/postfix/canonical
  when:
    - kohalxcs_kohaenv_enabled
  notify: Restart smtp

## Cronjobs for cheduled tasks: user 'koha' w/ $KOHA_CRONJOB_TRIGGER wrapper:
#  - "cronjobs/process_message_queue.pl -v"
#  - "migration_tools/rebuild_zebra.pl -a -b -x -z -v"
- name: koha - Add cronjob(s) for Koha
  become: yes
  cron:
    user: koha
    name: "{{ item.name }}"
    job: "$KOHA_CRONJOB_TRIGGER {{ kohalxcs_kohaenv_bindir }}/{{ item.job }}"
    minute: "{{ item.minute | d('*') }}"
    state: present
  with_items:
    - { name: "process_message_queue", job: "cronjobs/process_message_queue.pl -v" }
    - { name: "rebuild_zebra", job: "migration_tools/rebuild_zebra.pl -a -b -x -z -v", minute: "*/1" }
  when:
    - kohalxcs_kohaenv_enabled

## Use templatized koha-conf.xml to configure this Koha-instance
- name: koha - Templatized main Koha configuration
  become: yes
  template: >
    src="files/kohaenv/koha-conf.xml.j2"
    dest="{{ kohalxcs_kohaenv_kohaconf }}"
    mode="u=rw,g=r,o=r"
    owner="koha"
    group="{{ kohalxc_kohagrp_name }}"
    backup="yes"
  when:
    - kohalxcs_kohaenv_enabled
  notify: Restart webserver

## Push/copy 'run_conversion' script to ConversionTools
# - TODO: mode="u+rwx,g+rx,o-rwx"
- name: ppmmt - Push containerized conversion main script to ConversionTools
  #become: yes
  template: >
    src="files/dataenv/run_conversion-perl_import_pl.sh.j2"
    dest="{{ kohalxcs_kohalxc_tooldir }}/ppmmtws/ConversionTools/run_conversion.sh"
    mode="u+x,g+rx"
    backup="no"
  when:
    - kohalxcs_ppmmtenv_enabled

## Ensure 'run_conversion' script is symlinked to container $HOME/bin
- name: ppmmt - Symlink conversion main script in container HOME/bin
  file: >
    src="{{ kohalxcs_kohalxc_tooldir }}/ppmmtws/ConversionTools/run_conversion.sh"
    dest="{{ '/home/'~ansible_user~'/bin/run_conversion' }}"
    state="link"
    force="yes"
  when:
    - kohalxcs_ppmmtenv_enabled

- debug: var=kohalxcs_dataenv_enabled,kohalxcs_ppmmtenv_enabled,kohalxcs_ppmmtenv_importchains,kohalxcs_ppmmtenv_polling,kohalxcs_origommtenv_enabled,kohalxcs_mmtenv_enabled,kohalxcs_mmtenv_migrateme
## Run conversion: main script
# - might run very long time, async by default, poll and timeout in seconds
- name: data+ppmmt - Start main conversion script using 'lxc_config' ({{ (kohalxcs_ppmmtenv_timeout |d(7200)|int) // 60 }} mins)
  environment:
    KOHALXC_TOOLDIR: "{{ kohalxcs_kohalxc_tooldir }}"
    KOHALXC_DATADIR: "{{ '/home/'~ansible_user~'/'~kohalxcs_organization|d(kohalxc_organization)~'/kohadata' }}"
  shell: |
    ls -l ~/bin/run_conversion;
    echo && echo "== START OF PP/MMT CONVERSION '{{ kohalxcs_ppmmtenv_importchains | d() }}': $(date)" && echo;
    $HOME/bin/run_conversion lxc_config.xml {{ kohalxcs_ppmmtenv_importchains }} > /dev/null;
    [[ "0" == "$?" ]] && (head -35 $KOHALXC_TOOLDIR/ppmmtws/PerlMMT/logs/import_all.log; echo && echo "== ..CONVERTING.." && echo;)
  args:
    executable: /bin/bash
    chdir: "{{ '/home/'~ansible_user }}"
    creates: ~/bin/.run_conversion.finished
  async: "{{ kohalxcs_ppmmtenv_timeout | d(7200) }}"
  poll: "{{ kohalxcs_ppmmtenv_polling | d(0) }}"
  register: job_runconversion
  when:
    - kohalxcs_dataenv_enabled
    - kohalxcs_ppmmtenv_enabled
    - kohalxcs_ppmmtenv_importchains != ''

## Run conversion: check whether we are finished
- name: data+ppmmt - Is PP/MMT conversion run still on ({{ (kohalxcs_ppmmtenv_timeout|d(7200)|int) // kohalxcs_ppmmtenv_checkdelay|d(60) }} mins)
  async_status: jid={{ job_runconversion.ansible_job_id }}
  register: cmd_runconversion_result
  until: cmd_runconversion_result.finished
  retries: "{{ (kohalxcs_ppmmtenv_timeout|d(7200)|int) // kohalxcs_ppmmtenv_checkdelay|d(60) }}"
  delay: "{{ kohalxcs_ppmmtenv_checkdelay|d(60) }}"
  when:
    - kohalxcs_dataenv_enabled
    - kohalxcs_ppmmtenv_enabled
    - kohalxcs_ppmmtenv_importchains != ''

#- debug: var=job_runconversion_result,kohalxcs_kohalxc_tooldir
## Run conversion: finish the run (split/show log per ImportChains
- name: data+ppmmt - Finish conversion run (split/show log by import-chains)
  environment:
    KOHALXC_TOOLDIR: "{{ kohalxcs_kohalxc_tooldir }}"
    KOHALXC_DATADIR: "{{ '/home/'~ansible_user~'/'~kohalxcs_organization|d(kohalxc_organization)~'/kohadata' }}"
  shell: |
    tail -30 $KOHALXC_TOOLDIR/ppmmtws/PerlMMT/logs/import_all.log
    echo && echo "== END OF PP/MMT CONVERSION '{{ kohalxcs_ppmmtenv_importchains | d() }}': $(date)." && echo
    (cd $KOHALXC_DATADIR/source.0/logs && pwd && ls -l | grep '\-last\|\-previous' && echo)
    (cd $KOHALXC_DATADIR/source.0/target && pwd && ls -Csh && echo)
  when:
    - kohalxcs_dataenv_enabled
    - kohalxcs_ppmmtenv_enabled
    - kohalxcs_ppmmtenv_importchains != ''

## Make 'Staffaccounts' in addition to PP/MMT-Patrons
# - only if converting 'Patrons' & "kohlxcs_mmtenv_migrateme" has 'staffaccounts'
- name: data+ppmmt+(migrate) - Make Staff accounts for Koha (in addition to normal PatronsImportChain-conversion)
  environment:
    KOHALXC_TOOLDIR: "{{ kohalxcs_kohalxc_tooldir }}"
    KOHALXC_DATADIR: "{{ '/home/'~ansible_user~'/'~kohalxcs_organization|d(kohalxc_organization)~'/kohadata' }}"
  shell: |
    echo && echo "== ansible-kohalxc: Comment out below 'makeStaffAccouns.sh' (to ensure not overwriting 'testikoha' staffaccounts since 07.03.2017)"
    echo && ./makeStaffAccounts.sh Staffaccounts > /dev/null;
  args:
    executable: /bin/bash
    chdir: "{{ kohalxcs_kohalxc_tooldir }}/ppmmtws/ConversionTools"
  register: cmd_staffaccounts
  when:
    - kohalxcs_dataenv_enabled
    - kohalxcs_ppmmtenv_enabled
    - ('patrons' in kohalxcs_ppmmtenv_importchains|lower)
    - ('staffaccounts' in kohalxcs_mmtenv_migrateme|lower)

## Build '{Staffaccounts,Patrons,Biblios,Items,Holds,Checkouts,Fines}.migrateme's
- name: data+ppmmt - Build '*.migrateme' from conv targets to insert them to Koha
  environment:
    KOHALXC_TOOLDIR: "{{ kohalxcs_kohalxc_tooldir }}"
    KOHALXC_DATADIR: "{{ '/home/'~ansible_user~'/'~kohalxcs_organization|d(kohalxc_organization)~'/kohadata' }}"
  shell: |
    #ls -1sh && for d in "Staffaccounts Patrons Biblios Items Holds Checkouts Fines"
    ls -1sh && for d in "{{ kohalxcs_ppmmtenv_importchains | d() }}"
    do
       ([[ -d $d ]] && cd $d && echo && echo "== $d: $(pwd)" && rm -f ${d,,}.migrateme && cat 01_${d,,}* > ${d,,}.migrateme && ls -Csh --format=horizontal | grep -v "total" && echo -n "== $d lines: " && wc -l ${d,,}.migrateme || echo);
       #([[ -d $d ]] && cd $d && echo && echo "== $d: $(pwd)" && rm -f ${d,,}.migrateme && cat 01_${d,,}* > ${d,,}.migrateme && find */ -maxdepth 1 -name '${d,,}.migrateme' -exec cp -vp {} . \; 2>/dev/null; ls -Csh --format=horizontal | grep -v "total" && echo -n "== $d lines: " && wc -l ${d,,}.migrateme || echo);
    done
  args:
    executable: /bin/bash
    chdir: "{{ '/home/'~ansible_user~'/'~kohalxcs_organization|d(kohalxc_organization)~'/kohadata' }}/source.0/target"
  when:
    - kohalxcs_dataenv_enabled
    - kohalxcs_ppmmtenv_enabled
    - kohalxcs_ppmmtenv_importchains != ''

## Database: full dump of the db
#- name: Dump all databases to hostname.sql
#  mysql_db:
#    state: dump
#    name: all
#    login_user: "{{ kohalxc_mdbenv_kohauser }}"
#    login_password: "{{ kohalxc_mdbenv_kohauser }}"
#    target: /tmp/mdbenv-dump_{{ inventory_hostname }}_all-ddmmyyy.sql

## Database/status: 'patrons' and staffaccounts
# - could have "USE {{ kohalxcs_mdbenv_kohadb }}" in the sql, too
- name: koha+mdb - Show converted Patrons and Staff accounts that are in the db
  become: yes
  shell: |
    [[ -d Patrons ]] && ls -1shl Patrons && echo
    [[ -f Patrons/patrons.migrateme ]] && mysql -h {{ kohalxcs_mdbenv_dbhost }} -u {{ kohalxcs_mdbenv_kohauser }} --password={{ kohalxcs_mdbenv_kohapass }} {{ kohalxcs_mdbenv_kohadb }} -e 'SELECT userid,borrowernumber,cardnumber,branchcode,categorycode FROM borrowers WHERE categorycode <> "S" LIMIT 15;'
    [[ -d Staffaccounts ]] && ls -1shl Staffaccounts && echo
    [[ -f Staffaccounts/staffaccounts.migrateme ]] && mysql -h {{ kohalxcs_mdbenv_dbhost }} -u {{ kohalxcs_mdbenv_kohauser }} --password={{ kohalxcs_mdbenv_kohapass }} {{ kohalxcs_mdbenv_kohadb }} -e 'SELECT userid,borrowernumber,cardnumber,branchcode,categorycode FROM borrowers WHERE categorycode = "S" LIMIT 10;'; exit 0
  args:
    executable: /bin/bash
    chdir: "/home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/source.0/target"
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mdbenv_enabled
    - ('patrons' in kohalxcs_ppmmtenv_importchains|lower) or ('patrons' in kohalxcs_mmtenv_migrateme|lower) or ('staffaccounts' in kohalxcs_mmtenv_migrateme|lower)

## Push/copy KohaLXC/kohalxcs migration environment (mmtenv) customization scripts to target
- name: koha+mmt - Templatize bulkImport scripts/settings for migration LXCs
  become: yes
  template: >
    src="files/kohaenv/{{ item.name }}.j2"
    dest="/usr/share/koha/bin/{{ item.dir }}/{{ item.name}}"
    owner="koha"
    group="{{ kohalxc_kohagrp_name }}"
    mode="u=rwx,g=rx,o=rx"
    backup="yes"
  with_items:
    - { name: bulkPatronImport.pl, dir: migration_tools }
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - kohalxc_kohagrp_name is defined
    - ('patrons' in kohalxcs_ppmmtenv_importchains|lower) or ('patrons' in kohalxcs_mmtenv_migrateme|lower) or ('staffaccounts' in kohalxcs_mmtenv_migrateme|lower)

## Migrate
# TODO: SQL for preserving db tables data before migrating:
# USE kohadata.system_preferences: system settings
# - SELECT * FROM kohadata.system_preferences;
# USE kohadata.branches: libraries
# - SELECT * FROM kohadata.branches;
# USE kohadata.letters: notifications and message templates
# - SELECT * FROM kohadata.letters;
#
# TODO: Empty/clean these dbtables (Patrons and other) data before migrating:
# USE kohadata.issues: all
# - DELETE FROM issues WHERE issue_id <> 0;
# USE kohadata.borrowers: non-staff Patrons
# - DELETE FROM borrowers WHERE categorycode <> 'S' AND borrowernumber <> 1;
# USE kohadata.branchtransfers: all
# - TRUNCATE TABLE branchtransfers;
# - DELETE FROM branchtransfers WHERE  itemnumber <> 0;
# USE kohadata.branchrelations
# - TRUNCATE TABLE branchrelations;
# USE kohadata.message_queue
# - DELETE FROM kohadata.message_queue WHERE borrowernumber <> 0;

## Migrate (Patrons+Staffaccounts): start..
# TODO: this takes so long that we need async handling of task here!!
- name: koha+mmt - Migrate newly converted Patrons and/or Staff accounts ({{ (kohalxcs_ppmmtenv_timeout | d(7200) | int) // 60 }} mins)
  become: yes
  shell: |
    [[ -d Patrons ]] && ls -1shl Patrons && echo "== ansible-kohalxc: Started migrating 'Patrons' on $(date +%Y%m%d_%k%M).."
    [[ -f Patrons/patrons.migrateme ]] && head -9 Patrons/patrons.migrateme && su -l koha -c "bulkPatronImport.pl --file /home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/source.0/target/Patrons/patrons.migrateme --deduplicate &> log/bulkPatronImport-$(date +%Y%m%d_%k%M).log"
    [[ -d Staffaccounts ]] && ls -1shl Staffaccounts && echo "== ansible-kohalxc: Not migrating 'Staffaccounts' (for now)"
    #[[ -f Staffaccounts/staffaccounts.migrateme ]] && head -9 Staffaccounts/staffaccounts.migrateme && su -l koha -c "bulkPatronImport    head -3 Patrons/patrons.migrateme && head -3 Patrons/staffaccounts.migrateme.pl --file /home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/source.0/target/Staffaccounts/staffaccounts.migrateme &> log/bulkPatronImport-staffaccounts.log"
    exit 0
  args:
    executable: /bin/bash
    chdir: /home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/source.0/target
  async: "{{ kohalxcs_ppmmtenv_timeout | d(7200) }}"
  poll: "{{ kohalxcs_ppmmtenv_polling | d(0) }}"
  register: job_migratepatrons
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - ('patrons' in kohalxcs_ppmmtenv_importchains|lower)
    - ('patrons' in kohalxcs_mmtenv_migrateme|lower) or ('staffaccounts' in kohalxcs_mmtenv_migrateme|lower)

## Migrate (Patrons+Staffaccounts): .. are we finished yet?
- name: koha+mmt - Is 'Patrons' migration run still on ({{ (kohalxcs_ppmmtenv_timeout| d(7200) | int) // kohalxcs_ppmmtenv_checkdelay | d(60) }} mins)
  async_status: jid={{ job_migratepatrons.ansible_job_id }}
  register: cmd_migratepatrons_result
  until: cmd_migratepatrons_result.finished
  retries: "{{ (kohalxcs_ppmmtenv_timeout | d(7200) | int) // kohalxcs_ppmmtenv_checkdelay | d(60) }}"
  delay: "{{ kohalxcs_ppmmtenv_checkdelay | d(60) }}"
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - ('patrons' in kohalxcs_ppmmtenv_importchains|lower)
    - ('patrons' in kohalxcs_mmtenv_migrateme|lower) or ('staffaccounts' in kohalxcs_mmtenv_migrateme|lower)

## Migrate: 'biblios'
- name: koha+mmt - Migrate newly converted Biblios
  become: yes
  shell: |
    [[ -d Biblios ]] && ls -1shl Biblios && echo
    [[ -f Biblios/biblios.migrateme ]] && head -18 Biblios/biblios.migrateme
  args:
    executable: /bin/bash
    chdir: /home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/target
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - ('biblios' in kohalxcs_mmtenv_migrateme|lower)
    - ('biblios' in kohalxcs_ppmmtenv_importchains|lower)

- debug: var=kohalxcs_kohaenv_enabled,kohalxcs_ppmmtenv_enabled,kohalxcs_mmtenv_enabled,kohalxcs_mmtenv_migrateme
## Zebra: rebuild index
- name: koha+mmt - Rebuild Zebra index for Koha ({{ (kohalxcs_ppmmtenv_timeout|d(7200)|int) // 60 }} mins)
  become: yes
  #become_user: koha
  shell: |
    pwd && echo "== ansible-kohalxc: Rebuild and Start Zebra index for Koha ==";
    service koha-zebra-daemon stop
    ln -s -f /usr/share/koha/bin/koha-zebra-ctl.sh /etc/init.d/koha-zebra-daemon
    update-rc.d koha-zebra-daemon defaults
    service koha-zebra-daemon start
    chown koha -R /var/lib/koha
    su -l koha -c "/usr/share/koha/bin/migration_tools/rebuild_zebra.pl -b -r -v -x"
    echo && echo "== ansible-kohalxc: Zebra index rebuild done."
  args:
    executable: /bin/bash
    chdir: /home/{{ansible_user}}/{{kohalxc_organization}}/kohadata/target
  async: "{{ kohalxcs_ppmmtenv_timeout|d(7200) }}"
  poll: "{{ kohalxcs_ppmmtenv_polling|d(0) }}"
  register: job_rebuildidx
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - ('biblios' in kohalxcs_mmtenv_migrateme|lower)

- debug: var=kohalxcs_ppmmtenv_timeout,kohalxcs_ppmmtenv_checkdelay,kohalxcs_ppmmtenv_checkfinished
## Zebra rebuild: check whether we are finished
- name: koha+mmt - Is Biblios/Zebra index building still on ({{ (kohalxcs_ppmmtenv_timeout|d(7200)|int) // kohalxcs_ppmmtenv_checkdelay|d(60) }} mins)
  become: yes
  #become_user: koha
  async_status: jid={{ job_rebuildidx.ansible_job_id }}
  register: cmd_rebuildidx_result
  until: cmd_rebuildidx_result.finished
  retries: "{{ (kohalxcs_ppmmtenv_timeout|d(7200)|int) // kohalxcs_ppmmtenv_checkdelay|d(60) }}"
  delay: "{{ kohalxcs_ppmmtenv_checkdelay|d(60) }}"
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_mmtenv_enabled
    - ('biblios' in kohalxcs_mmtenv_migrateme|lower)

##
## Koha/webapp-setup after this point => TODO: move to kohaenv-setup.yaml
##

- debug: var=hostnode_kohaenv_srvname,kohalxcs_kohaenv_enabled,kohalxcs_kohaenv_srvname,kohalxcs_kohaenv_https,kohalxcs_kohaenv_sslle,kohalxc_organization
## Install LetsEncrypt/certbot client for SSL-certificates
- name: koha+ssl - Install LetsEncrypt from Git for SSL-certificate generation
  become: yes
  shell: mkdir -p /opt/letsencrypt && git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt &% cd /etc/letsencrypt && ./letsencrypt-auto certonly --email {{ kohalxcs_kohaenv_srvadmin | d() }} --apache -d {{ kohalxcs_kohaenv_srvname }}
  args:
    chdir: /opt
    executable: /bin/bash
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_kohaenv_https
    - kohalxcs_kohaenv_sslle

## Configure Koha(Apache2) OPAC and Intranet for https
- name: koha+ssl - Generate Koha/Apache2 https config (only if 'kohaenv_srvname' is set)
  become: yes
  #become_user: koha
  template: >
    src="files/kohaenv/{{ kohalxc_organization|lower }}-https.conf.j2"
    dest="/etc/koha/{{ kohalxc_organization|lower }}-https.conf"
    mode="u=rw,g=r,o=r"
    owner="koha"
    group="koha"
    backup="yes"
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxc_organization is defined
    - kohalxcs_kohaenv_https and kohalxcs_kohaenv_srvname

- name: koha+ssl - Make available our SSL-site configuration in Koha/Apache2
  become: yes
  shell: ln -s -f /etc/koha/{{ kohalxc_organization|lower }}-https.conf /etc/apache2/sites-available/koha-ssl.conf
  #shell: service apache stop && a2enmod ssl && a2dissite koha.conf && ln -s -f /etc/koha/{{ kohalxc_organization | lower }}-https.conf /etc/apache2/sites-enabled/koha-ssl.conf && service apache2 restart
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxc_organization is defined
    - kohalxcs_kohaenv_https and kohalxcs_kohaenv_srvname

## Generate SSL-certificate (self-signed)
- name: koha+ssl - Generate server.key and self-signed SSL-certificate for Koha/Apache2
  become: yes
  shell: mkdir -p /etc/apache2/ssl && openssl genrsa -des3 -passout pass:x -out /tmp/server.pass.key 2048 && openssl rsa -passin pass:x -in /tmp/server.pass.key -out /tmp/server.key && rm -f /tmp/server.pass.key && openssl req -new -subj "/C=FI/ST={{ hostnode_environment | d('local') }}/L={{ kohalxc_organization }}/O={{ kohalxcs_kohaenv_srvtitle | d('Koha Library') }}/OU={{ kohalxc_organization }} ({{ hostnode_environment | d('local') }})/CN={{ kohalxcs_kohaenv_srvname | d('localhost') }}" -key /tmp/server.key -out /tmp/server.csr && openssl x509 -req -sha256 -days 365 -in /tmp/server.csr -signkey /tmp/server.key -out /etc/apache2/ssl/server.crt && cp -vpf /tmp/server.key /etc/apache2/ssl/. && rm -f /tmp/server.*
  args:
    executable: /bin/bash
    chdir: /tmp
    creates: /etc/apache2/ssl/server.crt
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxc_organization is defined
    - kohalxcs_kohaenv_https and kohalxcs_kohaenv_srvname
    - (kohalxcs_kohaenv_sslle is not defined) or (not kohalxcs_kohaenv_sslle)

- name: koha+ssl - Enable SSL (switch to https) restart Koha/Apache2
  become: yes
  shell: service apache2 stop && a2dissite koha.conf && a2enmod ssl && a2ensite koha-ssl.conf
  when:
    - kohalxcs_kohaenv_enabled
    - kohalxcs_kohaenv_https and kohalxcs_kohaenv_srvname
  notify: Restart webserver

## !! For debug/dev FAIL here on purpose..!! ##
#- fail:
