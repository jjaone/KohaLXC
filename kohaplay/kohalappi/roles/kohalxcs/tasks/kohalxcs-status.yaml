---
# File: roles/kohalxcs/tasks/kohalxcs-status.yaml
# #############################################################################
# Code is part of the KohaLXC/kohatools Ansible/Bash tooling environment
# for Koha/ILS-development, deployment & database conversion/migration tasks.
# Author: Jukka Aaltonen, Koha-Lappi, Rovaniemi City Library, Lapland/Finland.
# License: GNU General Public License version 3.
# 
# Description:
# - status and details of Koha-related LXCs for all inventories 
# ##############################################################################

## Welcome to kohalxcs..
- name: status - Welcome '{{ hostnode_operuser }}' to kohalxcs/status..
  shell: |
    uname -a
    grep a
    whoami
    pwd
    ls -la
    history
    #echo "inventory_hostname={{inventory_hostname}}, ansible_host={{ansible_host}}, ansible_user={{ansible_user}}"
    #dpkg -l {{ kohalxcs_devenv_pckgs | d('bash') }} 
  args:
    executable: /bin/bash
  ignore_errors: yes

## TODO: Initialize+reload local facts
# - mostly for environment enablement of LXCs

## Set the kohalxcs defaults as localized ansible facts
# - TODO: this requires the folder /etc/ansible/facts.d to have been created
# - TODO: is this even needed -> commenting out for now!
#- name: status - Set default custom facts (for this role)
#  become: yes
#  template: |
#    src=files/kohalxcs.fact
#    dest=/etc/ansible/facts.d
#    force=yes

# Load kohalxcs environment defaults as localized ansible facts
- name: status - Reload default/custom facts (ansible_local.kohalxcs)
  setup: >
    fact_path="{{ kohalxcs_kohalxc_tooldir }}/conf.d/env.data/lxcs/{{inventory_hostname}}/config"
    filter="ansible_local"
#- debug: var=ansible_host,inventory_hostname,ansible_local.kohalxcs.default,ansible_local.kohalxcs.default.devenv_enabled,ansible_local.kohalxcs.default.dataenv_enabled,ansible_local.kohalxcs.default.mmtenv_enabled,ansible_local.kohalxcs.default.mdbenv_enabled,ansible_local.kohalxcs.default.kohaenv_enabled
- debug: var=ansible_local
- debug: var=ansible_host,inventory_hostname,kohalxcs_devenv_enabled,kohalxcs_dataenv_enabled,kohalxcs_mmtenv_enabled,kohalxcs_ppmmtenv_enabled,kohalxcs_mdbvenv_enabled,kohalxcs_kohaenv_enabled

## Extract the environment enablements from lxc.group(s)
#- name: status - Extract KohaLXC environment enablements from lxc.group(s)
#  become: yes
#  shell:
#  shell: lxc-info --name=`echo {{ inventory_hostname }} | cut -d"." -f1` -c lxc.group | tr "\n" " " | cut -d"=" -f2- | cut -c2- | sed 's/{{ hostnode_environment }} //'

## Some vars: status/debug 
#- debug: var=hostnode_operuser,kohalxc_operuser
#- debug: var=ansible_host,ansible_user,ansible_host,inventory_hostname
#- debug: var=hostnode_srvname
#- debug: var=hostnode_lxcs
#- debug: var=kohalxcs_devenv_enabled,kohalxcs_dataenv_enabled,kohalxcs_mdbenv_enabled,kohalxcs_kohaenv_enabled
