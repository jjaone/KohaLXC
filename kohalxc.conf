#!/bin/bash

###############################################################################
# Code is part of KohaLXC/kohatools env for KohaLappi-dev/deployment project  #
###############################################################################
# KohaLXC-script settings (kohalxc.conf) sourcing rest of kohatools/setup envs
#
# Author: Jukka Aaltonen, Linux/opensource developer, KohaLappi, Finland.
# Organization: Rovaniemi City Library, Lapland (Koha-Lappi project)
#
# Description:
# - settings to configure, create, start/stop, destroy and use Koha-LXC/hosts
#
# Created: 2016-08-15 by "roikohadev" (@jjaone)
# History:
#
# License: Gnu General Public License version 3.
###############################################################################

## [verbose]: show the 'kohalxc-environment that have been set previously .."
[[ -n "$VERBOSE" ]] && env | grep KOHALXC | sort


#######################################
# Settings: Tool & Koha Setup env
#######################################

## Set the KOHALXVC tools/config environment
# This script
KOHALXC_SCRIPT="${app:-kohalxc}"

# USER HOME RC-file
KOHALXC_RC="$HOME/.kohalxc.rc"
# Koha-works main directory
KOHALXC_WORKS="${KOHALXC_WORKS:-$HOME/Works}"
# KohaLXC-organization (i.e. "KohaLappi" or "KohaSuomi" )
KOHALXC_ORGANIZATION="${KOHALXC_ORGANIZATION:-KohaSuomi}"

# KohaLXC-tools main directory
KOHALXC_ROOTDIR="${KOHALXC_ROOTDIR:-$HOME/Works/KohaLXC}"
# KohaLXC-kohasetup tools main directory (to be used mainly in containers) 
KOHALXC_TOOLDIR="${KOHALXC_TOOLDIR:-$KOHALXC_ROOTDIR/kohatools}"
# Folder for koha-configs and setups, to be used in host and also in containers (dirname)
KOHALXC_CONFIGDIR="config"
# Kohalcx container-specific main configuration (filename)
KOHALXC_CONFIGFILE="kohalxc.conf"
# The LXC-config to be generated (filename)                               
KOHALXC_LXCCONFIG="config.conf"
# Folder for koha-lxc -specific logs (dirname)
KOHALXC_LOGDIR="logs"

# Web panel tool (lwp) for LXC-containers in http://localost:5000
KOHALXC_LWP_SCRIPT="${KOHALXC_LWP_SCRIPT:-$HOME/bin/lwp}"
KOHALXC_LWP_URL="${KOHALXC_LWP_URL:-$http://localhost:5000}"

## KohaLXC-containers setup settings
# Main directory for Koha-LXC containers setups/configs 
KOHALXC_SETUPDIR="${KOHALXC_SETUPDIR:-$KOHALXC_WORKS/$KOHALXC_ORGANIZATION/kohalxc}"
# Backup dir of Koha-LXC container setups/configs
KOHALXC_SETUPDIR_BACKUP="${KOHALXC_SETUPDIR}-backup"
# List of all configured/setup LXC-containers that we have
KOHALXC_LXCLIST=

# Container name, e.g.tkldev_mdbc9, xklprod_ksgitc9, to be set later..
KOHALXC_NAME=""
# (set later in 'kohalxc') The dir for named LXC-setups
# - KOHALXC_SETUP="$KOHALXC_SETUPDIR/$KOHALXC_NAME"
KOHALXC_SETUP=
# (set later in 'kohalxc') Container-specific configs KOHALXC-setup dir
# - KOHALXC_SETUP_CONFIGDIR="$KOHALXC_SETUP/$KOHALXC_CONFIGDIR"
KOHALXC_SETUP_CONFIGDIR=
# (set later in 'kohalxc') Container-specific logs kept under KOHALXC-setup dir
# - KOHALXC_SETUP_LOGDIR="$KOHALXC_SETUP/$KOHALXC_LOGDIR"
KOHALXC_SETUP_LOGDIR=
# (set later in 'kohalxc') Full path to container logfile..
#- KOHALXC_SETUP_LOGFILE="$KOHALXC_SETUP_LOGDIR/$KOHALXC_NAME.log"
KOHALXC_SETUP_LOGFILE=
# FATAL,CRIT,WARN,ERROR,(NOTICE),INFO,DEBUG.                           
KOHALXC_LOGLEVEL="${KOHALXC_LOGLEVEL:-NOTICE}"

## Defaults/details about specific container
# Description
KOHALXC_INFO="Ubuntu Xenial kohalappi dev from KS Git (3.16 master)"
# Distro details
KOHALXC_DISTRO="Ubuntu 16.04 Xenial LTS"
# Container Ubuntu release: xenial | trusty
KOHALXC_RELEASE="${KOHALXC_RELEASE:-xenial}"
# KOHALXC-setup variant: dev | test | prod
KOHALXC_VARIANT="${KOHALXC_VARIANT:-dev}"
KOHALXC_PACKAGES="joe,wget,git"
KOHALXC_SSHKEY="~/.ssh/id_rsa.pub"
KOHALXC_OPTS1="--packages KOHALXC_PACKAGES"
KOHALXC_OPTS2="--auth-key $KOHALXC_SSHKEY"
#KOHALXC_GITUSER=
#KOHALXC_GITEMAIL=
KOHALXC_AUTHOR="${kOHALXC_AUTHOR:-Koha Developer}"
KOHALXC_CREATED=`date +%Y-%m-%d`

KOHALXC_SERVER_SSHUSER="${KOHALXC_SERVER_SSHUSER:-ubuntu}"
KOHALXC_SERVER_SSHCMD="whoami && pwd && ls -la"
KOHALXC_SERVER_KOHALXC="home/$KOHALXC_SERVER_SSHUSER/kohalxc"
KOHALXC_SERVER_KOHATOOLS="home/$KOHALXC_SERVER_SSHUSER/kohatools"

## Path where lxc-containers are
KOHALXC_LXCPATH="${KOHALXC_LXCPATH:-/var/lib/lxc}"

## Ansible configuration manager root directory
KOHALXC_ANSIBLE_ROOTDIR="${KOHALXC_ROOTDIR}/ansible"
## Ansible configuration manager playbook directory
KOHALXC_ANSIBLE_PLAYBOOKS="${KOHALXC_ANSIBLE_ROOTDIR}/kohalappi"
## Ansible configuration manager playbook inventory (relative to playbook dir)
# - localdev, development, testing, production
KOHALXC_ANSIBLE_INVENTORY="localdev"
## Ansible configuration manager command line args
KOHALXC_ANSIBLE_CMDOPTS="--vault-password-file .vault.pass.txt --skip-tags=kohahosts:debug"
[[ -n "$DEBUG" ]] && KOHALXC_ANSIBLE_CMDOPTS="--vault-password-file .vault.pass.txt"
#KOHALXC_ANSIBLE_CMDOPTS="-v --ask-vault-pass"

## Finally, source the 'kohatools/kohasetup common settings/functions--'
[[ -f "$KOHALXC_TOOLDIR/conf.d/kohasetup.conf" ]] &&
   source $KOHALXC_TOOLDIR/conf.d/kohasetup.conf

# [verbose]: Tell the world about it..
[[ -n "$VERBOSE" ]] &&
    [[ "$?" -eq 0 ]] && ech "Sourced:" "$KOHALXC_TOOLDIR/conf.d/kohasetup.conf"
