---
# File: $KOHALXC_ANSIBLE_PLAYBOOKS/play-hostnodes.yaml
# #############################################################################
# Code is part of KohaLXC/kohatools Ansible/Bash tooling environment  
# for Koha/ILS-development, deployment & database conversion/migration tasks.
#
# Author: Jukka Aaltonen, Koha-Lappi, Rovaniemi City Library, Lapland/Finland.
#
# Description: "play for (koha-)servers and host/node environments":
# - hosts: all koha-related server hosts (from the inventory) 
# - tasks: 'hostnode' role: create and setup server hosts and
#          initialize 'lxcenv' (create all specified LXCs w/ networking)
#          for LXC-containers to be provisioned to koha-host server nodes.
# #############################################################################

## Hosts
- hosts: hostnodes

  ## gather_facts: False
  gather_facts: True

  ## Vars in files
  #vars_files:
    # Use to inlcude vars outside ansible root
    # - (/absolute/path/of/yaml/file.yaml)

  ## Get vars from user
  #vars_prompt:
  #  - name: userinput_vars
  #    prompt: "Input something?"
  #    tags: hostnodes:prerole

  ## Pre-tasks
  pre_tasks:
    - raw: echo "hostnodes(pre_tasks/raw) 'play-hostnodes.yaml'"
    - debug: var=inventory_hostname,hostnode_environment,hostnode_operid,kohalxc_operuser

    # List contents of read vars_files (if any)
    - name: List contents of preset vars (if any)
      debug: var=hostnode_var
      when:
        - hostnode_var is defined
        - userinput_vars is defined
        - userinput_vars == "y"
      tags: hostnodes:prerole

  ## Roles
  roles:
    - common
    - hostnode

  # Post-tasks
  post_tasks:
    - raw: echo "In hostnodes(post_tasks/raw) 'play-hostnodes.yaml'"

    # [debug]: List provisionable LXCs (if any)
    - name: List provisionable LXCs (if any)
      debug: var=hostnode_lxcs,hostnode_environment
      tags: hostnodes:postrole

    # [debug]: Show some ssh/connection vars
    - name: Show some ssh/connection vars
      debug: var=ansible_host,ansible_port,ansible_ssh_common_args,inventory_hostname
      tags: hostnodes:postrole
      
    # Add provisionable LXCs as new hosts (grouping them by their domain name) 
    - name: Set provisionable LXCs as hosts for detailed setup/config
      local_action: |
        add_host name="{{ item.name  + ('lxc.group = weblxc' in item.container_config) | ternary('.weblxc','.mdblxc') | d() }}" groups="{{ ('lxc.group = weblxc' in item.container_config) | ternary('weblxc','mdblxc') | d('lxc') }}" ansible_user="{{ kohalxc_operuser | d('ubuntu') }}" ansible_port=22 ansible_become_method="sudo" ansible_become_pass="{{ kohalxc_operpass | d('ubuntu') }}"
#    local_action: add_host name="{{ item.split('.')[0] }}" groups="{{ item.split('.')[-1] | d('lxc') }}"
      with_items: hostnode_lxcs | d()
      when:
      - item is defined and item != ""
      tags: hostnodes:postrole
